{% extends 'hubbase.html' %}

{% block head %}
 <link rel="stylesheet" href="../static/css/chat.css">

    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>My Chat App</title>


    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
    <script src="https://kit.fontawesome.com/191b087c0a.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

{% endblock %}

{% block content_name %}
Chat
{% endblock %}

{% block content %}

<div id="media-wrapper">
    <div id="canvas-wrapper">

    </div>
    <div id="divider-wrapper">
        <div ></div>
    </div>

    <div id="chat-wrapper">
        <strong>
            <p id="session-id">Session ID:  {{ room }}</p>
        </strong>

        <div id="flair-popup">
            <ul id="flairs">
                <li class = "flair">
                    Question
                </li>
                <li class = "flair">
                    Message
                </li>
                <li class = "flair">
                    Request
                </li>
                <li class="flair">
                    Canvas
                </li>
            </ul>
        </div>
        <div id="messages">
        </div>
        
            <div id="text-area-wrapper" >
                <textarea class="text-widget" id="chatbar" placeholder="Type a new message"> </textarea>
                <div id="widgets-wrapper" class="text-widget">
                    <div id="widgets">
                        <a><i class="fa-solid fa-paperclip fa-lg"></i></a>
                        <a><i class="fa-solid fa-tags fa-lg"></i></a>
                        <a><i class="fa-solid fa-paintbrush fa-lg"></i></a>
                        <a><i class="fa-solid fa-icons fa-lg"></i></a>
                    </div>
                    <div id="sendmessage">
                        <form id="message_input_form" class="form-container">    
                            <button type="submit" id="post" class="btn"><i class="fa-solid fa-paper-plane fa-lg"></i></button>
                        </form>
                    </div>
    
                </div>
            </div>
    </div>
</div>

<script>
    
const socket = io.connect("http://127.0.0.1:5000");

socket.on('connect', function () {
    socket.emit('join_room', {
        username: "{{ username }}",
        room: "{{ room }}"
    });

    let message_input = document.getElementById('chatbar');

    document.getElementById('message_input_form').onsubmit = function (e) {
        e.preventDefault();
        let message = message_input.value.trim();
        if (message.length) {
            socket.emit('send_message', {
                username: "{{username}}",
                room: "{{ room }}",
                message: message,
            })
        }
        message_input.value = '';
        message_input.focus();

    }
});

window.onbeforeunload = function () {
    socket.emit('leave_room', {
        username: "{{ username }}",
        room: "{{ room }}"
    })
};

socket.on('receive_message', function (data) {
    console.log(data);
    const newNode = document.createElement('div');
    newNode.className = 'message-wrapper';


    console.log(data.username);


    let newMessage = `
    <div class="message-header">
        <p>${data.username}</p>
        <p>${data.time}</p>
    </div>
    <div class="message-payload">
        <p>${data.message}</p>
    </div>

    `

    newNode.innerHTML = newMessage;

 
    document.getElementById('messages').appendChild(newNode);

    // keep the scroll at the bottom.
    var messageBody = document.querySelector('#messages');
    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
});

socket.on('join_room_announcement', function (data) {
    console.log(data);
    if (data.username !== "{{username}}") {
        const newNode = document.createElement('div');
        newNode.innerHTML = `<b>${data.time} ${data.username} has joined the room</b>`;
        document.getElementById('messages').appendChild(newNode);
    }
});

socket.on('leave_room_announcement', function (data) {
    console.log(data);
    const newNode = document.createElement('div');
    newNode.innerHTML = `<b>${data.username}</b> has left the room`;
    document.getElementById('messages').appendChild(newNode);
});


function openForm() {
document.getElementById("myForm").style.display = "block";
}

function closeForm() {
document.getElementById("myForm").style.display = "none";
}
</script>


<script src="../static/client.js"></script>
        

{% endblock %}


{% block body %}
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>



{% endblock %}
